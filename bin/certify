#!/bin/bash
#
#   certify
#


#
#   default[s]
#
[[ -z "$CERTIFY_ETC" ]] && CERTIFY_ETC="/etc/certify"


#
#   check[s]
#
[[ -z "$CERTIFY_CLOUDFLARE_API_TOKEN" ]] && echo "Error: CERTIFY_CLOUDFLARE_API_TOKEN environment variable is not set." && exit 1
[[ -z "$CERTIFY_EMAIL" ]] && echo "Error: CERTIFY_EMAIL environment variable is not set." && exit 1
[[ -z "$CERTIFY_ETC" ]] && echo "Error: CERTIFY_ETC environment variable is not set." && exit 1


#
#   prepare arg[s] domains [from env and/or file]
#
declare -A domain_set
domains=()

if [[ -f "${CERTIFY_ETC}/domains" ]]; then
  while IFS= read -r line || [[ -n "$line" ]]; do
    domain=$(echo "$line" | xargs)
    if [[ -n "$domain" ]]; then
      if [[ -z "${domain_set[$domain]:-}" ]]; then
        domain_set[$domain]=1
        domains+=("$domain")
      fi
    fi
  done < "${CERTIFY_ETC}/domains"
fi

if [[ -n "${CERTIFY_DOMAINS:-}" ]]; then
  IFS=',' read -r -a env_domains <<< "$CERTIFY_DOMAINS"
  for domain in "${env_domains[@]}"; do
    domain=$(echo "$domain" | xargs)
    if [[ -n "$domain" ]]; then
      if [[ -z "${domain_set[$domain]:-}" ]]; then
        domain_set[$domain]=1
        domains+=("$domain")
      fi
    fi
  done
fi

if [[ ${#domains[@]} -eq 0 ]]; then
  echo "Error: No domains found. Set CERTIFY_DOMAINS environment variable or create ${CERTIFY_ETC}/domains file with domain entries."
  exit 1
fi

# save de-duplicated domain[s]
mkdir -p "${CERTIFY_ETC}"
printf "%s\n" "${domains[@]}" > "${CERTIFY_ETC}/domains"

# prepare arg[s]
args=()
for domain in "${domains[@]}"; do
  args+=("-d" "$domain")
done


#
#   prepare dir[s]
#
mkdir -p "${CERTIFY_ETC}"
mkdir -p "${CERTIFY_ETC}/credentials"
mkdir -p "${CERTIFY_ETC}/credentials/cloudflare"
mkdir -p "${CERTIFY_ETC}/letsencrypt"
mkdir -p "${CERTIFY_ETC}/letsencrypt/cloudflare"


#
#   prepare credential[s]
#
echo "dns_cloudflare_api_token = $CERTIFY_CLOUDFLARE_API_TOKEN" > "${CERTIFY_ETC}/cloudflare/cloudflare.ini"
chmod 600 "${CERTIFY_ETC}/cloudflare/cloudflare.ini"


#
#   cert name [for --cert-name; default first domain]
#
cert_name="${CERTIFY_CERT_NAME:-${domains[0]}}"


#
#   certbot [issue if cert missing, expand if cert exists]
#
set -x
if [[ -d "${CERTIFY_ETC}/letsencrypt/live/${cert_name}" ]]; then
  certbot -v certonly \
    --config-dir "${CERTIFY_ETC}/letsencrypt" \
    --dns-cloudflare \
    --dns-cloudflare-credentials "${CERTIFY_ETC}/cloudflare/cloudflare.ini" \
    --email "$CERTIFY_EMAIL" \
    --agree-tos \
    --dns-cloudflare-propagation-seconds 30 \
    --non-interactive \
    --force-renewal \
    --cert-name "$cert_name" \
    --expand \
    "${args[@]}"
else
  certbot -v certonly \
    --config-dir "${CERTIFY_ETC}/letsencrypt" \
    --dns-cloudflare \
    --dns-cloudflare-credentials "${CERTIFY_ETC}/cloudflare/cloudflare.ini" \
    --email "$CERTIFY_EMAIL" \
    --agree-tos \
    --dns-cloudflare-propagation-seconds 30 \
    --non-interactive \
    --force-renewal \
    --cert-name "$cert_name" \
    "${args[@]}"
fi


#
# >:[-/-]:<
#
