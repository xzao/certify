#!/bin/bash
#
#   certify
#


#
#   default[s]
#
[[ -z "$CERTIFY_ETC" ]] && CERTIFY_ETC="/etc/certify"


#
#   check[s]
#
[[ -z "$CERTIFY_CLOUDFLARE_API_TOKEN" ]] && echo "Error: CERTIFY_CLOUDFLARE_API_TOKEN environment variable is not set." && exit 1
[[ -z "$CERTIFY_EMAIL" ]] && echo "Error: CERTIFY_EMAIL environment variable is not set." && exit 1
[[ -z "$CERTIFY_ETC" ]] && echo "Error: CERTIFY_ETC environment variable is not set." && exit 1


#
#   prepare arg[s] domains (from .dns file and/or CERTIFY_DOMAINS env)
#
declare -A domain_set
domains=()

if [[ -f ".dns" ]]; then
  while IFS= read -r line || [[ -n "$line" ]]; do
    domain=$(echo "$line" | xargs)
    if [[ -n "$domain" ]]; then
      if [[ -z "${domain_set[$domain]:-}" ]]; then
        domain_set[$domain]=1
        domains+=("$domain")
      fi
    fi
  done < ".dns"
fi

if [[ -n "${CERTIFY_DOMAINS:-}" ]]; then
  IFS=',' read -r -a env_domains <<< "$CERTIFY_DOMAINS"
  for domain in "${env_domains[@]}"; do
    domain=$(echo "$domain" | xargs)
    if [[ -n "$domain" ]]; then
      if [[ -z "${domain_set[$domain]:-}" ]]; then
        domain_set[$domain]=1
        domains+=("$domain")
      fi
    fi
  done
fi

if [[ ${#domains[@]} -eq 0 ]]; then
  echo "Error: No domains found. Set CERTIFY_DOMAINS environment variable or create a .dns file with domain entries."
  exit 1
fi

args=()
for domain in "${domains[@]}"; do
  args+=("-d" "$domain")
done


#
#   prepare dir[s]
#
mkdir -p "${CERTIFY_ETC}"
mkdir -p "${CERTIFY_ETC}/credentials"
mkdir -p "${CERTIFY_ETC}/credentials/cloudflare"
mkdir -p "${CERTIFY_ETC}/letsencrypt"
mkdir -p "${CERTIFY_ETC}/letsencrypt/cloudflare"


#
#   prepare credential[s]
#
echo "dns_cloudflare_api_token = $CERTIFY_CLOUDFLARE_API_TOKEN" > "${CERTIFY_ETC}/cloudflare/cloudflare.ini"
chmod 600 "${CERTIFY_ETC}/cloudflare/cloudflare.ini"


#
#   certbot
#
set -x
certbot -v certonly \
  --config-dir "${CERTIFY_ETC}/letsencrypt" \
  --dns-cloudflare \
  --dns-cloudflare-credentials "${CERTIFY_ETC}/cloudflare/cloudflare.ini" \
  --email "$CERTIFY_EMAIL" \
  --agree-tos \
  --dns-cloudflare-propagation-seconds 30 \
  --non-interactive \
  --force-renewal \
  "${args[@]}"
